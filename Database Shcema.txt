-- === Minimal HR Co-Pilot (MVP) Schema ===
-- PostgreSQL 12+ (uses generated columns)

-- Roles for platform users (same roles you described)
DO $$ BEGIN
  CREATE TYPE role_t AS ENUM ('super_user','hr','leader','chm','it','admin');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- ---------- USERS ----------
CREATE TABLE IF NOT EXISTS users (
  id             SERIAL PRIMARY KEY,
  email          VARCHAR(150) UNIQUE NOT NULL,
  full_name      VARCHAR(120)        NOT NULL,
  role           role_t              NOT NULL,
  password_hash  TEXT,                     -- store a hash if you need auth
  is_active      BOOLEAN             NOT NULL DEFAULT TRUE,
  created_at     TIMESTAMPTZ         NOT NULL DEFAULT now()
);

-- Small helper to keep updated_at fresh
CREATE OR REPLACE FUNCTION set_updated_at() RETURNS trigger AS $$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ---------- SUBMISSIONS ----------
-- Single record drives the whole pipeline for a resignation.
CREATE TABLE IF NOT EXISTS submissions (
  id                      SERIAL PRIMARY KEY,
  employee_name           VARCHAR(100) NOT NULL,
  employee_email          VARCHAR(150) NOT NULL,

  joining_date            DATE         NOT NULL,
  submission_date         DATE         NOT NULL DEFAULT CURRENT_DATE,
  last_working_day        DATE         NOT NULL,

  -- High-level workflow state (free text for MVP)
  resignation_status      VARCHAR(30)  NOT NULL DEFAULT 'submitted',

  -- Approvals
  team_leader_reply       BOOLEAN,           -- TRUE=approved, FALSE=rejected, NULL=pending
  team_leader_notes       TEXT,
  chinese_head_reply      BOOLEAN,
  chinese_head_notes      TEXT,

  -- Exit interview
  exit_interview_status   VARCHAR(30)  NOT NULL DEFAULT 'not_scheduled', -- scheduled|done|no_show
  exit_interview_notes    TEXT,

  -- IT / Assets
  it_support_reply        BOOLEAN,           -- final result from IT (optional summary)

  -- Finalization
  vendor_mail_sent        BOOLEAN      NOT NULL DEFAULT FALSE,
  medical_card_collected  BOOLEAN      NOT NULL DEFAULT FALSE,

  -- Useful computed fields
  in_probation            BOOLEAN GENERATED ALWAYS AS (
    (submission_date - joining_date) < 90          -- < 90 days
  ) STORED,
  notice_period_days      INTEGER GENERATED ALWAYS AS (
    (last_working_day - submission_date)           -- days
  ) STORED,

  created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Keep updated_at fresh
DROP TRIGGER IF EXISTS trg_submissions_updated ON submissions;
CREATE TRIGGER trg_submissions_updated
BEFORE UPDATE ON submissions
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- Helpful indexes for the dashboard
CREATE INDEX IF NOT EXISTS idx_submissions_status       ON submissions (resignation_status);
CREATE INDEX IF NOT EXISTS idx_submissions_employee_eml ON submissions (employee_email);

-- ---------- ASSETS ----------
-- One row per submission containing the simple asset checklist.
CREATE TABLE IF NOT EXISTS assets (
  id          SERIAL PRIMARY KEY,
  res_id      INTEGER NOT NULL REFERENCES submissions(id) DEFERRABLE INITIALLY DEFERRED,
  laptop      BOOLEAN,
  mouse       BOOLEAN,
  headphones  BOOLEAN,
  others      TEXT,           -- free text / extra notes
  approved    BOOLEAN,        -- overall asset clearance
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);

DROP TRIGGER IF EXISTS trg_assets_updated ON assets;
CREATE TRIGGER trg_assets_updated
BEFORE UPDATE ON assets
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE INDEX IF NOT EXISTS idx_assets_res_id ON assets (res_id);

-- (Optional) If you really want submissions â†’ assets pointer too, add this AFTER assets exists:
-- ALTER TABLE submissions
--   ADD COLUMN assets_entry_id INTEGER,
--   ADD CONSTRAINT fk_submissions_assets
--     FOREIGN KEY (assets_entry_id) REFERENCES assets(id)
--     DEFERRABLE INITIALLY DEFERRED;
